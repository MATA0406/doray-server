/********************************************
 * ê°œì„ ëœ ìë™ ì¶œí‡´ê·¼ ìŠ¤í¬ë¦½íŠ¸ (macOS)
 *  - í•˜ë£¨ ì¢…ì¼ log stream ê°ì‹œ
 *  - 18ì‹œ ì´í›„ 15ë¶„ ë¯¸ê°ì§€ ì‹œ í‡´ê·¼
 *  - 21ì‹œ ì´í›„ ê°•ì œ í‡´ê·¼ ì‹œë„(1íšŒ)
 *  - 10ë¶„ë§ˆë‹¤ log stream ì¬ì‹œì‘
 ********************************************/

const os = require("os");
const puppeteer = require("puppeteer");
const { spawn } = require("child_process");

// -------------------------
// í™˜ê²½ì„¤ì • ë° ì „ì—­ ë³€ìˆ˜
// -------------------------
const TARGET_MAC = "60:06:E3:97:04:E5";

let lastRSSI = null; // ê°€ì¥ ìµœê·¼ì— ê°ì§€ëœ RSSI
let lastDetectedTime = null; // ë§ˆì§€ë§‰ BT ê°ì§€ ì‹œê°
let logProcess = null; // log stream í”„ë¡œì„¸ìŠ¤
let isWorkStarted = false; // ì˜¤ëŠ˜ ì¶œê·¼ ì²˜ë¦¬ ì—¬ë¶€ (í”„ë¡œì„¸ìŠ¤ ì¬ì‹œì‘ ì‹œ ë¦¬ì…‹ë¨)
let workEndInterval = null; // í‡´ê·¼ ê°ì§€ setInterval
let forcedCheckOutDone = false; // 21ì‹œ ê°•ì œ í‡´ê·¼(1íšŒ) ì—¬ë¶€
let isCheckoutInProgress = false; // í‡´ê·¼ ìë™í™” ë™ì‹œ ì‹¤í–‰ ë°©ì§€ í”Œë˜ê·¸
let isLogStreamRunning = false; // log stream ì¤‘ë³µ ì‹¤í–‰ ë°©ì§€

// Store today's check-in/check-out times
let todaysCheckInTime = null;
let todaysCheckOutTime = null;

// -------------------------
// í—¬í¼ í•¨ìˆ˜: ì¬ì‹œë„ ë¡œì§
// -------------------------
async function retryOperation(operation, retries = 3, delay = 3000) {
  let attempt = 0;
  while (attempt < retries) {
    try {
      return await operation();
    } catch (err) {
      attempt++;
      console.error(`ì‘ì—… ì‹¤íŒ¨ (ì‹œë„ ${attempt}/${retries}): ${err.message}`);
      if (attempt < retries) {
        await new Promise((res) => setTimeout(res, delay));
      } else {
        throw err;
      }
    }
  }
}

// -------------------------
// RSSI í•´ì„ í•¨ìˆ˜
// -------------------------
function getSignalStrength(rssi) {
  if (rssi >= -50) return "ğŸŸ¢ ë§¤ìš° ê°•í•¨";
  if (rssi >= -60) return "ğŸŸ¡ ê°•í•¨";
  if (rssi >= -70) return "ğŸŸ  ë³´í†µ";
  return "ğŸ”´ ì•½í•¨";
}

// -------------------------
// ì¶œê·¼ ì‹œê°„ ì²´í¬ (ì˜¤ì „ 8:00 ~ 9:30)
// -------------------------
function isWorkTime() {
  const now = new Date();
  const hour = now.getHours();
  const minute = now.getMinutes();
  return hour === 8 || (hour === 9 && minute <= 30);
}

// -------------------------
// ì‹¤ì‹œê°„ Bluetooth ë¡œê·¸ ê°ì‹œ
// -------------------------
function startLogStream() {
  if (isLogStreamRunning) {
    console.log("âš ï¸ startLogStream ì´ë¯¸ ì‹¤í–‰ ì¤‘, ì¤‘ë³µ í˜¸ì¶œ ë°©ì§€");
    return;
  }
  isLogStreamRunning = true;

  console.log(`\nğŸš€ ì‹¤ì‹œê°„ Bluetooth ê°ì§€ ì‹œì‘... (ëŒ€ìƒ: ${TARGET_MAC})`);

  // log stream í”„ë¡œì„¸ìŠ¤ ì‹¤í–‰
  logProcess = spawn(
    "sudo",
    ["log", "stream", "--predicate", 'process == "nearbyd"', "--info"],
    {
      stdio: ["inherit", "pipe", "pipe"],
    }
  );

  // ë¡œê·¸ ë°ì´í„°ë¥¼ ìˆ˜ì‹ í•˜ì—¬ ëŒ€ìƒ MAC ë° RSSI ì²˜ë¦¬
  logProcess.stdout.on("data", (data) => {
    try {
      const output = data.toString();
      if (output.includes(TARGET_MAC)) {
        const timestamp = new Date().toLocaleString("ko-KR", {
          timeZone: "Asia/Seoul",
        });
        const matchRSSI = output.match(/RSSI (-?\d+)/);
        const rssi = matchRSSI ? parseInt(matchRSSI[1]) : null;

        // ë§¤ ê°ì§€ ì‹œ ë§ˆì§€ë§‰ ê°ì§€ ì‹œê°„ ì—…ë°ì´íŠ¸
        lastDetectedTime = new Date();

        // ì¶œê·¼ ì¡°ê±´ ì²´í¬: ì•„ì§ ì¶œê·¼í•˜ì§€ ì•Šì•˜ê³ , ì¶œê·¼ ì‹œê°„ì´ë©°, RSSI ê°’ì´ ë³€ê²½ëœ ê²½ìš°
        if (!isWorkStarted && isWorkTime() && rssi !== lastRSSI) {
          const signalStrength = getSignalStrength(rssi);
          console.log(`[${timestamp}] âœ… ëŒ€ìƒ ê¸°ê¸° ê°ì§€ë¨! (ì¶œê·¼ ë¡œì§)`);
          console.log(`ğŸ“¡ Bluetooth Address: ${TARGET_MAC}`);
          console.log(`ğŸ“¶ RSSI ê°’: ${rssi} (${signalStrength})`);
          console.log("ğŸš€ ì¶œê·¼ ìë™í™” íŠ¸ë¦¬ê±° ì‹¤í–‰!");
          console.log("----------------------------------------------------");

          // macOS ì•Œë¦¼
          spawn("osascript", [
            "-e",
            `display notification "Apple Watch ê°ì§€ë¨ - ì¶œê·¼ ê¸°ë¡" with title "Auto Check-in" subtitle "RSSI: ${rssi} (${signalStrength})"`,
          ]);

          lastRSSI = rssi;
          isWorkStarted = true;

          // ì¶œê·¼ ìë™í™” ì‹¤í–‰ (ì¬ì‹œë„)
          retryOperation(startTicketing, 3, 2000)
            .then(() => {
              // ì¶œê·¼ í›„ í‡´ê·¼ ê°ì§€ ì‹œì‘
              startWorkEndInterval();
            })
            .catch((err) => console.error("ì¶œê·¼ ìë™í™” ì‹¤íŒ¨:", err));
        } else {
          // ë‹¨ìˆœ RSSI ì—…ë°ì´íŠ¸
          lastRSSI = rssi;
        }
      }
    } catch (error) {
      console.error("ë¡œê·¸ ë°ì´í„° ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜:", error);
    }
  });

  logProcess.stderr.on("data", (data) => {
    console.error(`âŒ log stream ì˜¤ë¥˜: ${data.toString()}`);
  });

  logProcess.on("close", () => {
    console.log("âš ï¸ log stream ì¢…ë£Œë¨ - ìë™ ì¬ì‹œì‘ ëŒ€ê¸°");
    isLogStreamRunning = false;
    setTimeout(startLogStream, 2000);
  });

  // 60ë¶„ë§ˆë‹¤ log stream ê°•ì œ ì¬ì‹œì‘ (ë©”ëª¨ë¦¬ ëˆ„ìˆ˜ ë°©ì§€ ë“±)
  setTimeout(() => {
    console.log("â™»ï¸ 60ë¶„ ê²½ê³¼ - log stream ê°•ì œ ì¬ì‹œì‘");
    if (logProcess) {
      logProcess.kill();
      isLogStreamRunning = false; // ê°•ì œ ì¢…ë£Œ í›„ ë‹¤ìŒ í˜¸ì¶œ ê°€ëŠ¥
    }
  }, 60 * 60 * 1000);
}

// -------------------------
// Puppeteer ì¶œê·¼ ìë™í™”
// -------------------------
async function startTicketing() {
  console.log("ğŸš€ ì¶œê·¼ ìë™í™” ì‹œì‘...");
  const headlessMode = process.env.DEBUG ? false : true;

  // ê³ ìœ í•œ í”„ë¡œí•„ ë””ë ‰í† ë¦¬ ìƒì„± (íƒ€ì„ìŠ¤íƒ¬í”„ ì‚¬ìš©)
  const profileDir = `/tmp/puppeteer_checkin_${Date.now()}`;

  const browser = await puppeteer.launch({
    headless: headlessMode,
    userDataDir: profileDir,
    args: ["--no-sandbox", "--disable-setuid-sandbox"]
  });
  const page = await browser.newPage();

  try {
    await page.goto(
      "https://monthlykitchen.dooray.com/work-schedule/user/register-month",
      { waitUntil: "networkidle2" }
    );
    await page.waitForSelector('input[title="ì•„ì´ë””"]', { timeout: 8000 });
    await page.waitForSelector('input[title="ë¹„ë°€ë²ˆí˜¸"]', { timeout: 8000 });

    const USERNAME = "jhjung";
    const PASSWORD = "sodlfmadms0!";

    console.log("ğŸ“ ì•„ì´ë”” ì…ë ¥ ì¤‘...");
    await page.type('.input-box input[type="text"]', USERNAME, { delay: 100 });
    console.log("ğŸ”‘ ë¹„ë°€ë²ˆí˜¸ ì…ë ¥ ì¤‘...");
    await page.type('.input-box input[type="password"]', PASSWORD, {
      delay: 100,
    });

    console.log("ğŸš€ ë¡œê·¸ì¸ ì‹œë„...");
    await page.click(".submit-button.blue");
    await page.waitForNavigation({ waitUntil: "networkidle2", timeout: 8000 });

    console.log("âœ… ë¡œê·¸ì¸ ì„±ê³µ! ì¶œê·¼ ë²„íŠ¼ íƒìƒ‰ ì¤‘...");
    const checkInButton = await page.evaluateHandle(() => {
      return [...document.querySelectorAll("button.check-button")].find((btn) =>
        btn.textContent.includes("ì¶œê·¼")
      );
    });

    if (checkInButton) {
      const isDisabled = await page.evaluate(
        (button) => button.disabled,
        checkInButton
      );
      if (!isDisabled) {
        console.log("âœ… ì¶œê·¼ ë²„íŠ¼ ì°¾ìŒ! í´ë¦­ ì‹œë„...");
        // ğŸ§ª TEST MODE: ì‹¤ì œ í´ë¦­ ëŒ€ì‹  ë¡œê·¸ë§Œ ì¶œë ¥
        console.log("ğŸ§ª [TEST MODE] ì¶œê·¼ ë²„íŠ¼ í´ë¦­ ì‹œë®¬ë ˆì´ì…˜!");
        console.log("ğŸ§ª [TEST MODE] ì‹¤ì œ ì¶œê·¼ ì²˜ë¦¬ëŠ” í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
        
        // await checkInButton.click();
        // console.log("ğŸš€ ì¶œê·¼ ë²„íŠ¼ í´ë¦­ ì™„ë£Œ!");

        console.log("ğŸ§ª [TEST MODE] ì¶œê·¼ ì™„ë£Œ ì‹œë®¬ë ˆì´ì…˜!");

        // Save today's check-in time
        todaysCheckInTime = new Date();
      } else {
        console.log("âŒ ì¶œê·¼ ë²„íŠ¼ì´ ì´ë¯¸ ë¹„í™œì„±í™”ë¨.");
      }
    } else {
      console.log("âŒ ì¶œê·¼ ë²„íŠ¼ì„ ì°¾ì§€ ëª»í•¨ (ì´ë¯¸ ì¶œê·¼í–ˆì„ ê°€ëŠ¥ì„±).");
    }
  } catch (error) {
    console.error("âŒ ì¶œê·¼ ìë™í™” ì¤‘ ì˜¤ë¥˜:", error);
    throw error;
  } finally {
    await browser.close();
    // ì„ì‹œ í”„ë¡œí•„ ë””ë ‰í† ë¦¬ ì •ë¦¬
    try {
      const fs = require('fs');
      fs.rmSync(profileDir, { recursive: true, force: true });
    } catch (e) {
      // ì •ë¦¬ ì‹¤íŒ¨ëŠ” ë¬´ì‹œ
    }
  }
}

// -------------------------
// Puppeteer í‡´ê·¼ ìë™í™”
// -------------------------
async function startCheckOut() {
  // ë™ì‹œ í‡´ê·¼ ì‹¤í–‰ ë°©ì§€
  if (isCheckoutInProgress) {
    console.log("âš ï¸ ì´ë¯¸ í‡´ê·¼ ìë™í™” ì§„í–‰ ì¤‘ì…ë‹ˆë‹¤.");
    return;
  }
  isCheckoutInProgress = true;
  console.log("ğŸš€ í‡´ê·¼ ìë™í™” ì‹œì‘...");
  const headlessMode = process.env.DEBUG ? false : true;

  // ê³ ìœ í•œ í”„ë¡œí•„ ë””ë ‰í† ë¦¬ ìƒì„± (íƒ€ì„ìŠ¤íƒ¬í”„ ì‚¬ìš©)
  const profileDir = `/tmp/puppeteer_checkout_${Date.now()}`;

  const browser = await puppeteer.launch({
    headless: headlessMode,
    userDataDir: profileDir,
    args: ["--no-sandbox", "--disable-setuid-sandbox"]
  });
  const page = await browser.newPage();

  try {
    await page.goto(
      "https://monthlykitchen.dooray.com/work-schedule/user/register-month",
      { waitUntil: "networkidle2" }
    );
    await page.waitForSelector('input[title="ì•„ì´ë””"]', { timeout: 8000 });
    await page.waitForSelector('input[title="ë¹„ë°€ë²ˆí˜¸"]', { timeout: 8000 });

    const USERNAME = "jhjung";
    const PASSWORD = "sodlfmadms0!";

    console.log("ğŸ“ ì•„ì´ë”” ì…ë ¥ ì¤‘...");
    await page.type('.input-box input[type="text"]', USERNAME, { delay: 100 });
    console.log("ğŸ”‘ ë¹„ë°€ë²ˆí˜¸ ì…ë ¥ ì¤‘...");
    await page.type('.input-box input[type="password"]', PASSWORD, {
      delay: 100,
    });

    console.log("ğŸš€ ë¡œê·¸ì¸ ì‹œë„...");
    await page.click(".submit-button.blue");
    await page.waitForNavigation({ waitUntil: "networkidle2", timeout: 8000 });

    console.log("âœ… ë¡œê·¸ì¸ ì„±ê³µ! í‡´ê·¼ ë²„íŠ¼ íƒìƒ‰ ì¤‘...");
    const checkOutButton = await page.evaluateHandle(() => {
      return [...document.querySelectorAll("button.check-button")].find((btn) =>
        btn.textContent.includes("í‡´ê·¼")
      );
    });

    if (checkOutButton) {
      console.log("âœ… í‡´ê·¼ ë²„íŠ¼ ì°¾ìŒ! í´ë¦­ ì‹œë„...");
      // ğŸ§ª TEST MODE: ì‹¤ì œ í´ë¦­ ëŒ€ì‹  ë¡œê·¸ë§Œ ì¶œë ¥
      console.log("ğŸ§ª [TEST MODE] í‡´ê·¼ ë²„íŠ¼ í´ë¦­ ì‹œë®¬ë ˆì´ì…˜!");
      console.log("ğŸ§ª [TEST MODE] ì‹¤ì œ í‡´ê·¼ ì²˜ë¦¬ëŠ” í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
      
      // await checkOutButton.click();
      // console.log("ğŸš€ í‡´ê·¼ ë²„íŠ¼ í´ë¦­ ì™„ë£Œ!");

      // ë²„íŠ¼ ë¹„í™œì„±í™”(í‡´ê·¼ ì™„ë£Œ) ëŒ€ê¸° - í…ŒìŠ¤íŠ¸ ëª¨ë“œì—ì„œëŠ” ìŠ¤í‚µ
      // await page.waitForFunction(
      //   () => {
      //     const btn = document.querySelector("button.check-button");
      //     return btn && btn.disabled === true;
      //   },
      //   { timeout: 10000 }
      // );

      console.log("ğŸ§ª [TEST MODE] í‡´ê·¼ ì™„ë£Œ ì‹œë®¬ë ˆì´ì…˜!");

      // macOS ì•Œë¦¼ - í…ŒìŠ¤íŠ¸ ëª¨ë“œì—ì„œë„ ìœ ì§€
      spawn("osascript", [
        "-e",
        `display notification "ğŸ§ª TEST MODE: í‡´ê·¼ ê¸°ë¡ ì‹œë®¬ë ˆì´ì…˜" with title "Auto Check-out TEST"`,
      ]);

      // Save today's check-out time
      todaysCheckOutTime = new Date();
    } else {
      console.log("âŒ í‡´ê·¼ ë²„íŠ¼ì„ ì°¾ì§€ ëª»í•¨ (ì´ë¯¸ í‡´ê·¼í–ˆê±°ë‚˜ ë¹„í™œì„±í™”ë¨).");
    }
  } catch (error) {
    console.error("âŒ í‡´ê·¼ ìë™í™” ì¤‘ ì˜¤ë¥˜:", error);
    throw error;
  } finally {
    await browser.close();
    // í‡´ê·¼ í›„ ìƒíƒœ ì´ˆê¸°í™” (ë‹¤ìŒ ì¶œê·¼ì„ ìœ„í•´)
    lastRSSI = null;
    isWorkStarted = false;
    lastDetectedTime = null;
    isCheckoutInProgress = false;
    // ì„ì‹œ í”„ë¡œí•„ ë””ë ‰í† ë¦¬ ì •ë¦¬
    try {
      const fs = require('fs');
      fs.rmSync(profileDir, { recursive: true, force: true });
    } catch (e) {
      // ì •ë¦¬ ì‹¤íŒ¨ëŠ” ë¬´ì‹œ
    }
  }
}

// -------------------------
// 18ì‹œ ì´í›„ 15ë¶„ ë¯¸ê°ì§€ ì‹œ í‡´ê·¼ ì²˜ë¦¬
// -------------------------
function startWorkEndInterval() {
  if (workEndInterval) {
    console.log("âš ï¸ í‡´ê·¼ ê°ì§€ íƒ€ì´ë¨¸ ì´ë¯¸ ì‹¤í–‰ ì¤‘");
    return;
  }
  console.log("â³ í‡´ê·¼ ê°ì§€ íƒ€ì´ë¨¸ ì‹œì‘... (ë§¤ 1ë¶„ ê°„ê²©)");

  workEndInterval = setInterval(async () => {
    const now = new Date();
    const hour = now.getHours();

    // 18ì‹œ ì´í›„ 15ë¶„(900ì´ˆ) ë¯¸ê°ì§€ ì‹œ í‡´ê·¼
    if (hour >= 18) {
      if (!lastDetectedTime) {
        // ê°ì§€ ì‹œê°„ì´ ì „í˜€ ì—†ìœ¼ë©´ í˜„ì¬ ì‹œê°„ìœ¼ë¡œ ì—…ë°ì´íŠ¸
        lastDetectedTime = new Date();
      }
      const timeDiff = (now - lastDetectedTime) / 1000; // ì´ˆ ë‹¨ìœ„

      // 15ë¶„ê°„ ë¯¸ê°ì§€
      if (timeDiff >= 900) {
        console.log("ğŸš€ 15ë¶„ê°„ Bluetooth ë¯¸ê°ì§€ - í‡´ê·¼ ìë™í™” ì‹¤í–‰!");

        // í‡´ê·¼ ì²˜ë¦¬
        try {
          await retryOperation(startCheckOut, 3, 2000);
        } catch (err) {
          console.error("í‡´ê·¼ ìë™í™” ì‹¤íŒ¨:", err);
        } finally {
          // ë‹¤ìŒ ë‚  ì¶œê·¼ ì „ê¹Œì§€ëŠ” í‡´ê·¼ ìƒíƒœ ìœ ì§€
          clearInterval(workEndInterval);
          workEndInterval = null;
          lastDetectedTime = null;
          forcedCheckOutDone = false;
        }
      }
    }
  }, 60 * 1000); // 1ë¶„ ê°„ê²©
}

// -------------------------
// í”„ë¡œì„¸ìŠ¤ ì¢…ë£Œ ì‹œ ì •ë¦¬
// -------------------------
process.on("exit", () => {
  console.log("í”„ë¡œì„¸ìŠ¤ ì¢…ë£Œë¨");
  if (logProcess) logProcess.kill();
  if (workEndInterval) clearInterval(workEndInterval);
});

// -------------------------
// ë§¤ì¼ ìì • í›„ ìƒíƒœ ì´ˆê¸°í™” ë¡œì§
// -------------------------
function scheduleMidnightReset() {
  const now = new Date();
  // ë‚´ì¼ ìì • ê³„ì‚°
  const tomorrow = new Date(
    now.getFullYear(),
    now.getMonth(),
    now.getDate() + 1,
    0,
    0,
    0,
    0
  );
  const msUntilMidnight = tomorrow - now;
  setTimeout(() => {
    // ìƒíƒœ ë³€ìˆ˜ ì´ˆê¸°í™”
    lastRSSI = null;
    lastDetectedTime = null;
    isWorkStarted = false;
    forcedCheckOutDone = false;
    isCheckoutInProgress = false;
    if (workEndInterval) {
      clearInterval(workEndInterval);
      workEndInterval = null;
    }
    console.log("ğŸŒ™ [Daily Reset] ëª¨ë“  ìƒíƒœ ë³€ìˆ˜ë¥¼ ì´ˆê¸°í™”í–ˆìŠµë‹ˆë‹¤.");
    // ë‚´ì¼ ìì •ì—ë„ ì‹¤í–‰ë˜ë„ë¡ ì¬ìŠ¤ì¼€ì¤„
    scheduleMidnightReset();
  }, msUntilMidnight);
}

// -------------------------
// ì „ì²´ í”„ë¡œì„¸ìŠ¤ ì‹œì‘ (ë©”ì¸)
// -------------------------
(function main() {
  const nowStr = new Date().toLocaleTimeString("ko-KR", {
    timeZone: "Asia/Seoul",
  });
  console.log(`\nâ¸ï¸ í˜„ì¬ ì‹œê°„: ${nowStr}`);
  console.log(`ì‚¬ìš©ì: jhjung`);

  // (1) ë¡œê·¸ ê°ì‹œ ì‹œì‘ (ì¢…ì¼ ìœ ì§€)
  startLogStream();

  // (2) í˜¹ì‹œ ì¶œê·¼ì„ ì´ë¯¸ í–ˆë‹¤ê³  ê°€ì •í•˜ê³ , í‡´ê·¼ ê°ì§€ íƒ€ì´ë¨¸ë„ ë°”ë¡œ ì‹œì‘
  //    - ì¶œê·¼ ì•ˆ í–ˆìœ¼ë©´ ì–´ì°¨í”¼ 18ì‹œ ì´í›„ì— "ë¯¸ê°ì§€ 15ë¶„" ì¡°ê±´ì€ ëª» ë§ì¶”ë‹ˆ OK
  startWorkEndInterval();

  // (3) í˜¹ì—¬ë‚˜ ì¬ì‹œì‘ ì‹œ, ì§€ê¸ˆ ì‹œê°„ì´ ì´ë¯¸ 21ì‹œë¥¼ ë„˜ì—ˆë‹¤ë©´, ê°•ì œ í‡´ê·¼ ì‹œë„
  // const hour = new Date().getHours();
  // if (hour >= 21 && !forcedCheckOutDone) {
  //   console.log('â° í”„ë¡œì„¸ìŠ¤ ì¬ì‹œì‘ ì‹œì ì´ 21ì‹œ ì´í›„ - ì¦‰ì‹œ ê°•ì œ í‡´ê·¼ ì‹œë„!');
  //   forcedCheckOutDone = true;
  //   retryOperation(startCheckOut, 3, 2000).catch(err => {
  //     console.error('ì¬ì‹œì‘ í›„ ê°•ì œ í‡´ê·¼ ì‹¤íŒ¨:', err);
  //   });
  // }
})();

// ë§¤ì¼ ìì • ì´í›„ ìƒíƒœ ì´ˆê¸°í™”ë¥¼ ìœ„í•œ ìŠ¤ì¼€ì¤„ë§ ì‹œì‘
scheduleMidnightReset();

// Return today's check-in and check-out status from actual Doray website
async function getTodayStatus() {
  console.log("ğŸ” ë‘ë ˆì´ì—ì„œ ì‹¤ì œ ì¶œí‡´ê·¼ ì‹œê°„ ì¡°íšŒ ì¤‘...");
  
  // ê³ ìœ í•œ í”„ë¡œí•„ ë””ë ‰í† ë¦¬ ìƒì„± (íƒ€ì„ìŠ¤íƒ¬í”„ ì‚¬ìš©)
  const profileDir = `/tmp/puppeteer_status_${Date.now()}`;
  
  const browser = await puppeteer.launch({
    headless: true,
    args: ["--no-sandbox", "--disable-setuid-sandbox"],
    userDataDir: profileDir
  });

  try {
    const page = await browser.newPage();
    await page.goto("https://monthlykitchen.dooray.com/work-schedule/user/register-month", {
      waitUntil: "networkidle2",
      timeout: 10000,
    });

    // ë¡œê·¸ì¸
    const USERNAME = "jhjung";
    const PASSWORD = "sodlfmadms0!";

    await page.type('.input-box input[type="text"]', USERNAME, { delay: 100 });
    await page.type('.input-box input[type="password"]', PASSWORD, { delay: 100 });
    await page.click(".submit-button.blue");
    await page.waitForNavigation({ waitUntil: "networkidle2", timeout: 8000 });

    console.log("âœ… ë¡œê·¸ì¸ ì„±ê³µ! ì¶œí‡´ê·¼ ê¸°ë¡ ì¡°íšŒ ì¤‘...");

    // í˜ì´ì§€ê°€ ì™„ì „íˆ ë¡œë“œë  ë•Œê¹Œì§€ ì ì‹œ ëŒ€ê¸°
    await new Promise(resolve => setTimeout(resolve, 2000));

    // XPathë¥¼ ì‚¬ìš©í•´ì„œ ì‹¤ì œ ì¶œí‡´ê·¼ ì‹œê°„ ê°€ì ¸ì˜¤ê¸°
    const todayStatus = await page.evaluate(() => {
      // XPathë¡œ ìš”ì†Œ ì°¾ëŠ” í—¬í¼ í•¨ìˆ˜
      function getElementByXPath(xpath) {
        return document.evaluate(xpath, document, null, XPathResult.FIRST_ORDERED_NODE_TYPE, null).singleNodeValue;
      }
      
      // ì¶œê·¼ ì‹œê°„ ê°€ì ¸ì˜¤ê¸° (ì œê³µëœ XPath ì‚¬ìš©)
      const checkInElement = getElementByXPath('/html/body/div[1]/div/div[2]/section/div/div[1]/div/div[1]/div[2]/div[2]/div[1]/p');
      const checkInTime = checkInElement ? checkInElement.textContent?.trim() : '';
      
      // í‡´ê·¼ ì‹œê°„ ê°€ì ¸ì˜¤ê¸° (ì¶œê·¼ ì‹œê°„ XPathì—ì„œ ìœ ì¶”)
      // ë³´í†µ ì¶œê·¼ì´ div[1]ì´ë©´ í‡´ê·¼ì€ div[2] ë˜ëŠ” div[3]ì¼ ê°€ëŠ¥ì„±ì´ ë†’ìŒ
      let checkOutTime = '';
      const possibleCheckOutPaths = [
        '/html/body/div[1]/div/div[2]/section/div/div[1]/div/div[1]/div[2]/div[2]/div[2]/p', // div[2]
        '/html/body/div[1]/div/div[2]/section/div/div[1]/div/div[1]/div[2]/div[2]/div[3]/p', // div[3]
        '/html/body/div[1]/div/div[2]/section/div/div[1]/div/div[1]/div[2]/div[3]/div[1]/p', // div[3]/div[1]
        '/html/body/div[1]/div/div[2]/section/div/div[1]/div/div[1]/div[2]/div[3]/div[2]/p'  // div[3]/div[2]
      ];
      
      for (const xpath of possibleCheckOutPaths) {
        const element = getElementByXPath(xpath);
        if (element && element.textContent?.trim()) {
          checkOutTime = element.textContent.trim();
          console.log(`ğŸ” [DEBUG] í‡´ê·¼ ì‹œê°„ì„ ì°¾ì•˜ìŠµë‹ˆë‹¤ (${xpath}):`, checkOutTime);
          break;
        }
      }
      
      console.log("ğŸ” [DEBUG] ì¶œê·¼ ì‹œê°„:", checkInTime);
      console.log("ğŸ” [DEBUG] í‡´ê·¼ ì‹œê°„:", checkOutTime);
      
      // ì‹œê°„ í˜•ì‹ ê²€ì¦ (HH:MM í˜•íƒœì¸ì§€ í™•ì¸)
      const timePattern = /^\d{2}:\d{2}$/;
      const validCheckIn = timePattern.test(checkInTime) ? checkInTime : '';
      const validCheckOut = timePattern.test(checkOutTime) ? checkOutTime : '';
      
      return {
        checkIn: validCheckIn,
        checkOut: validCheckOut
      };
    });

    console.log("âœ… ë‘ë ˆì´ ì¶œí‡´ê·¼ ìƒíƒœ ì¡°íšŒ ì™„ë£Œ:", todayStatus);
    return todayStatus;

  } catch (error) {
    console.error("âŒ ë‘ë ˆì´ ìƒíƒœ ì¡°íšŒ ì‹¤íŒ¨:", error);
    // ì‹¤íŒ¨ ì‹œ ë©”ëª¨ë¦¬ì— ì €ì¥ëœ ê°’ ë°˜í™˜
    return {
      checkIn: todaysCheckInTime
        ? todaysCheckInTime.toLocaleTimeString("ko-KR", { hour: "2-digit", minute: "2-digit", timeZone: "Asia/Seoul" })
        : "",
      checkOut: todaysCheckOutTime
        ? todaysCheckOutTime.toLocaleTimeString("ko-KR", { hour: "2-digit", minute: "2-digit", timeZone: "Asia/Seoul" })
        : ""
    };
  } finally {
    await browser.close();
    // ì„ì‹œ í”„ë¡œí•„ ë””ë ‰í† ë¦¬ ì •ë¦¬
    try {
      const fs = require('fs');
      fs.rmSync(profileDir, { recursive: true, force: true });
    } catch (e) {
      // ì •ë¦¬ ì‹¤íŒ¨ëŠ” ë¬´ì‹œ
    }
  }
}

module.exports = {
  startCheckIn: startTicketing,
  startCheckOut,
  getTodayStatus
};
